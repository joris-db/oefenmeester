<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Myrthe's Oefenmeester</title>
    
    <!-- PWA & Apple Integration -->
    <link rel="apple-touch-icon" href="https://raw.githubusercontent.com/joris-db/oefenmeester/refs/heads/main/icon.png">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#020617">

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <style>
        :root { --slate-950: #020617; }
        body { 
            background-color: var(--slate-950); 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            margin: 0; height: 100vh; overflow: hidden;
            -webkit-tap-highlight-color: transparent; user-select: none; color: white;
        }
        .app-container { height: 100vh; display: flex; flex-direction: column; overflow-y: auto; -webkit-overflow-scrolling: touch; }
        .glass { background: rgba(30, 41, 59, 0.7); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px); border: 1px solid rgba(255,255,255,0.1); }
        .numpad-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; }
        .scroll-hide::-webkit-scrollbar { display: none; }
        
        .flag-card {
            aspect-ratio: 3 / 2;
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            border-radius: 1rem;
            background: #1e293b;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .flag-img { width: 100%; height: 100%; object-fit: cover; }

        @keyframes levelUp {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        .animate-levelup { animation: levelUp 0.4s ease-out; }
        
        .progress-bar { height: 8px; background: rgba(255,255,255,0.1); border-radius: 99px; overflow: hidden; }
        .progress-fill { height: 100%; background: linear-gradient(90deg, #6366f1, #a855f7); transition: width 0.6s cubic-bezier(0.34, 1.56, 0.64, 1); }

        .correct-highlight { border: 4px solid #10b981 !important; transform: scale(1.02); }
        .wrong-highlight { border: 4px solid #f43f5e !important; opacity: 0.6; }
        
        .app-logo {
            width: 52px; height: 52px;
            border-radius: 1.1rem;
            object-fit: cover;
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.4);
        }

        /* Webpushr Custom Integration Styling */
        .notification-card {
            margin-top: 1.5rem;
            padding: 1.25rem;
            border-radius: 1.5rem;
            background: linear-gradient(145deg, rgba(255, 255, 255, 0.05), rgba(255, 255, 255, 0.02));
            border: 1px solid rgba(255, 255, 255, 0.08);
            width: 100%;
            max-width: 340px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.75rem;
        }
        .notification-card p {
            font-size: 0.7rem;
            font-weight: 800;
            letter-spacing: 0.05em;
            text-transform: uppercase;
            color: #64748b;
        }
        /* Zorg dat de Webpushr toggle knop goed centreert */
        #webpushr-subscription-toggle-button {
            display: inline-block !important;
            min-height: 30px;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useCallback, useRef } = React;

        const appId = 'myrthe-oefenmeester-v9';
        const APP_ICON_URL = "https://raw.githubusercontent.com/joris-db/oefenmeester/refs/heads/main/icon.png";

        // --- DATA ---
        const germanLidlWords = [
            { nl: "De vergadering", de: "Besprechung" }, { nl: "De afspraak", de: "Termin" }, { nl: "De collega", de: "Kollege" }, { nl: "De afdeling", de: "Abteilung" },
            { nl: "Het kantoor", de: "BÃ¼ro" }, { nl: "De e-mail", de: "E-Mail" }, { nl: "De bijlage", de: "Anhang" }, { nl: "Het verslag", de: "Protokoll" },
            { nl: "De deadline", de: "Frist" }, { nl: "De opdracht", de: "Auftrag" }, { nl: "De planning", de: "Planung" }, { nl: "De strategie", de: "Strategie" },
            { nl: "De doelstelling", de: "Zielsetzung" }, { nl: "Het project", de: "Projekt" }, { nl: "De feedback", de: "RÃ¼ckmeldung" }, { nl: "De presentatie", de: "PrÃ¤sentation" },
            { nl: "De inkoop", de: "Einkauf" }, { nl: "De leverancier", de: "Lieferant" }, { nl: "De onderhandeling", de: "Verhandlung" }, { nl: "De prijs", de: "Preis" },
            { nl: "De klant", de: "Kunde" }, { nl: "De korting", de: "Rabatt" }, { nl: "De factuur", de: "Rechnung" }, { nl: "De voorraad", de: "Lagerbestand" },
            { nl: "De aanbieding", de: "Angebot" }, { nl: "De supermarkt", de: "Supermarkt" }, { nl: "De kassa", de: "Kasse" }, { nl: "De medewerker", de: "Mitarbeiter" },
            { nl: "Het filiaal", de: "Filiale" }, { nl: "De manager", de: "GeschÃ¤ftsfÃ¼hrer" }, { nl: "Het magazijn", de: "Lager" }, { nl: "De vrachtwagen", de: "LKW" },
            { nl: "Het product", de: "Produkt" }, { nl: "De kwaliteit", de: "QualitÃ¤t" }, { nl: "De versheid", de: "Frische" }, { nl: "De verpakking", de: "Verpackung" },
            { nl: "Het schap", de: "Regal" }, { nl: "De mand", de: "Korb" }, { nl: "De kar", de: "Einkaufswagen" }, { nl: "De bon", de: "Quittung" }
        ];

        const compliments = ["Top gedaan!", "Lekker bezig!", "Super slim!", "Je gaat als een raket! ðŸš€", "Wauw!", "Perfect! âœ¨"];
        const encouragement = ["Bijna!", "Volgende keer beter!", "Kop op!", "Nog een keer proberen!"];

        // --- HELPERS ---
        const Icon = ({ name, size = 24, className = "" }) => {
            const iconRef = useRef(null);
            useEffect(() => {
                if (window.lucide && iconRef.current) {
                    iconRef.current.innerHTML = '';
                    const iconElement = document.createElement('i');
                    iconElement.setAttribute('data-lucide', name);
                    iconElement.style.width = `${size}px`;
                    iconElement.style.height = `${size}px`;
                    if (className) iconElement.setAttribute('class', className);
                    iconRef.current.appendChild(iconElement);
                    window.lucide.createIcons();
                }
            }, [name, size, className]);
            return <span ref={iconRef} className="inline-flex items-center justify-center" />;
        };

        const App = () => {
            const [view, setView] = useState('menu');
            const [countries, setCountries] = useState([]);
            const [feedback, setFeedback] = useState(null);
            const [selectedChoice, setSelectedChoice] = useState(null);
            const [stats, setStats] = useState(() => {
                const saved = localStorage.getItem(`${appId}_stats`);
                return saved ? JSON.parse(saved) : {
                    xp: 0, level: 1, streak: 0,
                    correctMath: 0, correctGerman: 0, correctFlags: 0,
                    mathLevel: 1, flagBestStreak: 0,
                    totalPoints: 0, badges: []
                };
            });

            // --- WEBPUSHR LOGIC ---
            useEffect(() => {
                if (view === 'menu') {
                    // Forceer Webpushr om de toggle knop opnieuw te renderen
                    if (window._webpushr && typeof window._webpushr.refresh_toggle === 'function') {
                        window._webpushr.refresh_toggle();
                    }
                }
            }, [view]);

            // --- INITIAL LOAD ---
            useEffect(() => {
                const loadCountries = async () => {
                    try {
                        const response = await fetch('https://restcountries.com/v3.1/all?fields=name,translations,flags');
                        const data = await response.json();
                        setCountries(data.map(c => ({
                            name: c.translations?.nld?.common || c.name?.common,
                            flag: c.flags?.svg || c.flags?.png
                        })).filter(c => c.name && c.flag));
                    } catch (e) {
                        setCountries([{name: "Nederland", flag: "https://flagcdn.com/nl.svg"}]);
                    }
                };
                loadCountries();
            }, []);

            useEffect(() => {
                localStorage.setItem(`${appId}_stats`, JSON.stringify(stats));
            }, [stats]);

            const getXpThreshold = (lvl) => Math.floor(100 * Math.pow(1.15, lvl - 1));

            const addXP = (amount, key) => {
                setStats(prev => {
                    let nXp = prev.xp + amount;
                    let nLvl = prev.level;
                    const threshold = getXpThreshold(nLvl);
                    if (nXp >= threshold) { nXp -= threshold; nLvl++; }
                    return { ...prev, xp: nXp, level: nLvl, totalPoints: prev.totalPoints + amount, [key]: (prev[key] || 0) + 1 };
                });
            };

            // --- GAME LOGIC ---
            const [examState, setExamState] = useState(null);
            const [mathProblem, setMathProblem] = useState({ q: '', a: 0 });
            const [userAnswer, setUserAnswer] = useState('');
            const [currentProblem, setCurrentProblem] = useState(null);
            const [streakCount, setStreakCount] = useState(0);

            const generateMath = (lvl) => {
                const n1 = Math.floor(Math.random() * (lvl * 10)) + 2;
                const n2 = Math.floor(Math.random() * (lvl * 10)) + 2;
                return { q: `${n1} + ${n2}`, a: n1 + n2 };
            };

            const generateFlag = (mode = 'flags') => {
                if (!countries.length) return null;
                const correct = countries[Math.floor(Math.random() * countries.length)];
                const opts = [correct];
                while(opts.length < 4) {
                    const r = countries[Math.floor(Math.random() * countries.length)];
                    if(!opts.find(o => o.name === r.name)) opts.push(r);
                }
                return { ...correct, opts: opts.sort(() => Math.random() - 0.5), category: mode };
            };

            const handleChoice = (ans) => {
                if (feedback) return;
                setSelectedChoice(ans);
                const isCorrect = (currentProblem.category === 'german') ? (ans === currentProblem.de) : (ans.name === currentProblem.name);
                
                if (isCorrect) {
                    addXP(15, 'correctFlags');
                    setFeedback({ type: 'success', text: compliments[Math.floor(Math.random() * compliments.length)] });
                    setTimeout(() => {
                        setFeedback(null);
                        setSelectedChoice(null);
                        if (view === 'flag-streak') {
                            setStreakCount(s => s + 1);
                            setCurrentProblem(generateFlag('flags'));
                        } else {
                            setCurrentProblem(currentProblem.category === 'german' ? { ...germanLidlWords[Math.floor(Math.random() * germanLidlWords.length)], category: 'german', opts: [] } : generateFlag(currentProblem.category));
                        }
                    }, 1000);
                } else {
                    setFeedback({ type: 'error', text: encouragement[Math.floor(Math.random() * encouragement.length)] });
                    if (view === 'flag-streak') setTimeout(() => setView('menu'), 1500);
                    else setTimeout(() => { setFeedback(null); setSelectedChoice(null); }, 1500);
                }
            };

            // --- COMPONENTS ---
            const Header = ({ title, onBack }) => (
                <div className="pt-12 pb-4 px-6 flex justify-between items-center bg-slate-900/95 sticky top-0 z-50 border-b border-white/5">
                    <button onClick={onBack} className="p-2 -ml-2 text-slate-400 active:scale-90"><Icon name="chevron-left" size={28} /></button>
                    <div className="text-center">
                        <h2 className="text-[10px] font-black uppercase tracking-[0.2em] text-slate-500 italic leading-none mb-1">{title}</h2>
                        <div className="flex items-center justify-center gap-1 text-orange-500 font-bold text-[10px] uppercase">
                            <Icon name="flame" size={12} /> {stats.streak} dag streak
                        </div>
                    </div>
                    <div className="w-10 h-10 glass rounded-xl flex items-center justify-center text-indigo-400 font-black text-xs">L{stats.level}</div>
                </div>
            );

            // --- VIEWS ---
            if (view === 'menu') {
                const threshold = getXpThreshold(stats.level);
                const progress = (stats.xp / threshold) * 100;
                
                return (
                    <div className="app-container p-6 items-center">
                        <div className="w-full max-w-sm pt-8 mb-8 flex justify-between items-center">
                            <div className="flex items-center gap-4">
                                <img src={APP_ICON_URL} className="app-logo" alt="logo" />
                                <div>
                                    <p className="text-[10px] font-black text-slate-500 uppercase tracking-widest leading-none mb-1">Myrthe's</p>
                                    <p className="text-xl font-black italic uppercase tracking-tighter leading-none">Oefenmeester</p>
                                </div>
                            </div>
                            <button onClick={() => setView('stats')} className="w-12 h-12 glass rounded-2xl flex items-center justify-center text-orange-400 shadow-lg active:scale-95"><Icon name="trophy" size={20} /></button>
                        </div>

                        <div className="w-full max-w-sm mb-10 glass p-5 rounded-3xl">
                            <div className="flex justify-between items-end mb-3">
                                <span className="text-[10px] font-black uppercase text-slate-400 tracking-wider">Level {stats.level}</span>
                                <span className="text-xs font-black text-indigo-400">{Math.round(stats.xp)} XP</span>
                            </div>
                            <div className="progress-bar"><div className="progress-fill" style={{ width: `${progress}%` }} /></div>
                        </div>

                        <div className="w-full max-w-sm space-y-4 mb-10">
                            <button onClick={() => { setMathProblem(generateMath(stats.mathLevel)); setView('math'); }} className="w-full glass p-5 rounded-[2rem] flex items-center gap-5 active:scale-98 border-l-4 border-indigo-500">
                                <div className="bg-indigo-600 p-4 rounded-2xl shadow-lg"><Icon name="calculator" size={24} /></div>
                                <div className="text-left"><span className="block text-lg font-black italic uppercase">Rekenen</span><span className="text-[10px] font-bold text-slate-500 uppercase">Sommen oefenen</span></div>
                            </button>
                            <button onClick={() => { setCurrentProblem(generateFlag('flags')); setView('flags'); }} className="w-full glass p-5 rounded-[2rem] flex items-center gap-5 active:scale-98 border-l-4 border-emerald-500">
                                <div className="bg-emerald-600 p-4 rounded-2xl shadow-lg"><Icon name="flag" size={24} /></div>
                                <div className="text-left"><span className="block text-lg font-black italic uppercase">Vlaggen</span><span className="text-[10px] font-bold text-slate-500 uppercase">Landen raden</span></div>
                            </button>
                            <button onClick={() => setView('menu')} className="w-full glass p-5 rounded-[2rem] flex items-center gap-5 opacity-60 border-l-4 border-rose-500 grayscale">
                                <div className="bg-rose-600 p-4 rounded-2xl shadow-lg"><Icon name="languages" size={24} /></div>
                                <div className="text-left"><span className="block text-lg font-black italic uppercase text-slate-400">Duits</span><span className="text-[10px] font-bold text-slate-600 uppercase">Coming Soon</span></div>
                            </button>
                        </div>

                        {/* Webpushr Notification Card */}
                        <div className="notification-card">
                           <p>Blijf op de hoogte</p>
                           <span id="webpushr-subscription-toggle-button" 
                                 data-size="1.1" 
                                 data-text-when-denied="Meldingen geblokkeerd" 
                                 data-tooltip-position="bottom" 
                                 data-color="#6366f1">
                           </span>
                        </div>
                    </div>
                );
            }

            if (view === 'math') {
                return (
                    <div className="app-container">
                        <Header title="Rekenen" onBack={() => setView('menu')} />
                        <div className="flex-1 flex flex-col items-center justify-center p-6 text-center">
                            <div className="text-7xl font-black mb-12 tracking-tighter drop-shadow-2xl">{mathProblem.q}</div>
                            <div className="text-5xl font-mono bg-slate-900 w-full max-w-[220px] py-6 rounded-[2.5rem] border-2 border-indigo-500/40 text-indigo-400 shadow-inner">{userAnswer || "?"}</div>
                            <div className="h-16 mt-8">
                                {feedback && <div className={`font-black uppercase text-sm px-6 py-3 rounded-2xl shadow-xl ${feedback.type === 'success' ? 'bg-emerald-500' : 'bg-rose-500'}`}>{feedback.text}</div>}
                            </div>
                        </div>
                        <div className="bg-slate-900/95 p-6 pb-12 glass border-t border-white/5">
                            <div className="numpad-grid max-w-xs mx-auto">
                                {[1,2,3,4,5,6,7,8,9,'C',0,'OK'].map(b => (
                                    <button key={b} onClick={() => {
                                        if (b === 'OK') {
                                            const isCorrect = parseInt(userAnswer) === mathProblem.a;
                                            if (isCorrect) {
                                                addXP(20, 'correctMath');
                                                setFeedback({ type: 'success', text: compliments[0] });
                                                setTimeout(() => { setMathProblem(generateMath(stats.mathLevel)); setUserAnswer(''); setFeedback(null); }, 1000);
                                            } else {
                                                setFeedback({ type: 'error', text: `${mathProblem.a}` });
                                                setTimeout(() => { setUserAnswer(''); setFeedback(null); }, 1500);
                                            }
                                        } else if (b === 'C') setUserAnswer('');
                                        else if (userAnswer.length < 4) setUserAnswer(userAnswer + b);
                                    }} className="h-16 rounded-2xl bg-white/5 font-black text-2xl active:bg-white/20 border border-white/5">{b}</button>
                                ))}
                            </div>
                        </div>
                    </div>
                );
            }

            if (view === 'flags' && currentProblem) {
                return (
                    <div className="app-container">
                        <Header title="Vlaggen" onBack={() => setView('menu')} />
                        <div className="flex-1 flex flex-col p-8 items-center gap-6">
                            <div className="text-center space-y-2">
                                <span className="text-slate-500 uppercase text-[10px] font-black tracking-widest block">Zoek de vlag van</span>
                                <h2 className="text-3xl font-black italic uppercase tracking-tighter text-white">{currentProblem.name}</h2>
                            </div>
                            
                            <div className="grid grid-cols-2 gap-4 w-full max-w-sm mt-4">
                                {currentProblem.opts.map((o, i) => (
                                    <button key={i} onClick={() => handleChoice(o)} className={`flag-card glass border-2 active:scale-95 ${selectedChoice === o ? (o.name === currentProblem.name ? 'correct-highlight' : 'wrong-highlight') : 'border-transparent'}`}>
                                        <img src={o.flag} className="flag-img" alt="flag" />
                                    </button>
                                ))}
                            </div>
                            <div className="h-16 mt-4">
                                {feedback && <div className={`font-black uppercase text-sm px-6 py-3 rounded-2xl shadow-xl ${feedback.type === 'success' ? 'bg-emerald-500' : 'bg-rose-500'}`}>{feedback.text}</div>}
                            </div>
                        </div>
                    </div>
                );
            }

            if (view === 'stats') {
                return (
                    <div className="app-container">
                        <Header title="Statistieken" onBack={() => setView('menu')} />
                        <div className="p-6 space-y-4 max-w-sm mx-auto w-full">
                            <div className="grid grid-cols-2 gap-4">
                                <div className="glass p-6 rounded-3xl text-center"><Icon name="flame" className="text-orange-500 mb-2" /><div className="text-2xl font-black">{stats.streak}</div><div className="text-[10px] font-bold text-slate-500 uppercase">Streak</div></div>
                                <div className="glass p-6 rounded-3xl text-center"><Icon name="star" className="text-indigo-500 mb-2" /><div className="text-2xl font-black">{stats.level}</div><div className="text-[10px] font-bold text-slate-500 uppercase">Level</div></div>
                            </div>
                            <div className="glass p-5 rounded-3xl space-y-3">
                                <div className="flex justify-between items-center"><span className="text-xs font-bold text-slate-400">Sommen goed</span><span className="font-black">{stats.correctMath || 0}</span></div>
                                <div className="flex justify-between items-center"><span className="text-xs font-bold text-slate-400">Vlaggen goed</span><span className="font-black">{stats.correctFlags || 0}</span></div>
                                <div className="flex justify-between items-center border-t border-white/5 pt-3"><span className="text-xs font-black text-white">Totaal XP</span><span className="font-black text-indigo-400">{stats.totalPoints}</span></div>
                            </div>
                            <button onClick={() => setView('menu')} className="w-full bg-white text-slate-950 p-5 rounded-3xl font-black uppercase italic active:scale-95 mt-4">Terug naar Home</button>
                        </div>
                    </div>
                );
            }

            return null;
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
    
    <!-- Webpushr Script met Mobile Optimizations -->
    <script>
        (function(w,d, s, id) {
            if(typeof(w.webpushr)!=='undefined') return;
            w.webpushr=w.webpushr||function(){(w.webpushr.q=w.webpushr.q||[]).push(arguments)};
            var js, fjs = d.getElementsByTagName(s)[0];
            js = d.createElement(s); js.id = id; js.async = 1;
            js.src = "https://cdn.webpushr.com/app.js";
            fjs.parentNode.insertBefore(js, fjs);
        }(window,document, 'script', 'webpushr-jssdk'));

        // Optioneel: Luister naar webpushr events om status te loggen (handig voor debugging op mobiel)
        window.webpushr('onNotificationPrompt', function(status) {
            console.log('Webpushr prompt status:', status);
        });
    </script>
</body>
</html>